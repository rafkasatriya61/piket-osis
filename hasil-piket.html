<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Laporan Guru | OSIS</title>
    <link rel="stylesheet" href="https://rafkasatriya61.github.io/pusat-css/hasil.css">
</head>
<body>
    <div class="container">
        <div id="login-guru" class="glass-effect">
            <h2>Portal Monitoring</h2>
            <p style="text-align: center; margin-bottom: 20px; opacity: 0.8;">Wali Kelas & Guru BK</p>
            <form id="form-login-guru">
                <input type="text" id="nama-guru" placeholder="Nama Lengkap" required>
                <input type="password" id="pass-guru" placeholder="Password (kelas)" required>
                <button type="submit" class="btn-send">Masuk & Lihat Data</button>
            </form>
        </div>

        <div id="data-laporan" class="glass-effect" style="display: none; max-width: 95%; width: 900px;">
            <h2 id="judul-halaman">Data Pelanggaran</h2>
            <p id="filter-info" style="text-align: center; font-size: 0.9em; margin-bottom: 20px; color: #25D366;"></p>
            
            <div class="table-container">
                <table id="tabel-hasil">
                    <thead>
                        <tr>
                            <th>WAKTU</th>
                            <th>NAMA SISWA</th>
                            <th>PELANGGARAN</th>
                            <th>PETUGAS</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            
            <button onclick="location.reload()" class="btn-logout">Keluar Dashboard</button>
        </div>
    </div>

    <script>
        // Link CSV Google Sheets kamu
        const csvUrl = "https://docs.google.com/spreadsheets/d/165QaH8Lg2P8TXn30V4Xm95QNUfgZqMirty9B5GetGv8/export?format=csv";

        // Daftar Akun Guru
        const akunGuru = {
            "ibu mulyana": "10 tkr",
            "mis monica": "10 mp",
            "admin": "admin123"
        };

        document.getElementById('form-login-guru').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('nama-guru').value.toLowerCase();
            const pass = document.getElementById('pass-guru').value.toLowerCase();

            if (akunGuru[user] === pass) {
                const parts = pass.split(' ');
                // Mengirim filter Kelas, Jurusan, dan Username
                loadData(parts[0], parts[1]?.toUpperCase() || "", user);
            } else {
                alert("âŒ Login Gagal! Periksa kembali Nama dan Password.");
            }
        });

        async function loadData(kelas, jurusan, user) {
            try {
                const response = await fetch(csvUrl);
                const csvText = await response.text();
                
                // Pisahkan per baris dan buang baris header (baris pertama)
                const rows = csvText.split('\n').slice(1); 
                const tbody = document.querySelector('#tabel-hasil tbody');
                tbody.innerHTML = '';
                
                let count = 0;
                rows.forEach(row => {
                    // Regex untuk memisahkan kolom CSV dengan aman (menangani tanda koma dalam tanda kutip)
                    const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                    
                    if (cols.length >= 6) {
                        const rowKelas = cols[2]?.trim();
                        const rowJurusan = cols[3]?.trim();

                        // Filter: Jika admin, tampilkan semua. Jika guru, tampilkan kelas & jurusan yang cocok.
                        if (user === "admin" || (rowKelas === kelas && rowJurusan === jurusan)) {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td style="color: #bbb;">${cols[0]}</td>
                                <td style="font-weight: 600; color: #fff;">${cols[1]}</td>
                                <td style="font-style: italic;">${cols[4]?.replace(/"/g, '')}</td>
                                <td>${cols[5]}</td>
                            `;
                            tbody.appendChild(tr);
                            count++;
                        }
                    }
                });

                // Ganti tampilan dari login ke dashboard
                document.getElementById('login-guru').style.display = 'none';
                document.getElementById('data-laporan').style.display = 'block';
                
                const filterText = user === "admin" ? "Semua Jurusan" : `Kelas ${kelas} ${jurusan}`;
                document.getElementById('filter-info').innerText = `Menampilkan ${count} laporan untuk ${filterText}`;
                
            } catch (err) {
                console.error(err);
                alert("Gagal sinkronisasi data dengan Spreadsheet!");
            }
        }
    </script>
</body>
</html>
